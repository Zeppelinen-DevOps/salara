###########################################################################################
#
# 		salara - Asterisk rest api module
#
###########################################################################################

## Файлы пакета:

* salara.conf	- файл конфигурации модуля

* Makefile	- make файл (файл сценария компиляции модуля)

* salara.c	- source (исходник модуля)

Имя файла модуля - salara.so

Требуемые заголовочные файлы (Required headers):
```
- asterisk headers files (из пакета asterisk)
- libcurl headers files (из пакета devel)
- libjansson headers files (из пакета devel)
```
Требуемые библиотеки (Required library):
```
- libcurl.so.4 or high (https://curl.haxx.se/download.html)
- libjansson.so.4 or high (http://www.digip.org/jansson/)
```

## Компиляция и установка модуля

make

Скопировать файлы :

* salara.so	в папку /usr/lib/asterisk/modules/	(папка с модулями asterisk)

* salara.conf	в папку /etc/asterisk/			(папка с файлами конфигурации asterisk)

Загрузка модуля с консоли asterisk:
```
module load salara.so
```
При успешной загрузке в консоли появится примерно следубщее сообщение:
```
Loaded salara.so
  == Registered application 'salara'
 Loaded salara.so => (Features: transfer call; make call; get status: exten.,peer,channel; send: command,message,post)
[salara 14:13:56.141] SEND_BY_EVENT Thread started (tid:2886441792).
```

Получить список консольных команд модуля:
```
core show help salara
```


# Функции модуля


## 1. POST запросы к модулю salara (на порт 5058) в формате json

### 1.1 Создать соединение (make call) между двум абонентами :
```
{
    "operator": "8003",
    "phone": "0000",
    "context": "alnik"
}
```
где,
* "operator" - внутренный абонент (caller) - обязательное поле
* "phone" - внешний или внутренний абонент (called) - обязательное поле
* "context" - контекст абонента caller - не обязательное поле

Алгоритм поведения модуля :
*  проверяется статус абонента caller, если статус удовлетворительный - делается вызов на этого абонента;
*  после ответа абонента caller, вызывается абонент called.

Ответ модуля на такой запрос имеет следующий вид :
```
{"result":0,"text":"Idle"}
```
где,
* "result" - содержит статус абонента caller
* "text" - текстовая интерпретация статуса абонента caller.

### 1.2 Послать текстовое сообщение (msg send) внутреннему абоненту :
```
{
    "operator": "8003",
    "phone": "8002",
    "msg": "текст сообщения",
    "context": "general"
}
```
где,
* "operator" - получатель сообщения, абонент, которому посылается сообщение - обязательное поле
* "phone" - отправител, абонент, от имени которого посылается сообщение - обязательное поле
* "msg" - текст сообщения -обязательное поле
* "context" - контекст получателя - не обязательное поле

Алгоритм поведения модуля :
  - проверяется статус получателя, если статус удовлетворительный - отправляется сообщение

Ответ модуля на такой запрос имеет следующий вид :
```
{"result":0,"text":"Idle"}
```
где,
* "result" - содержит статус получателя
* "text" - текстовая интерпретация статуса получателя.

### 1.3 Запрос статуса внутреннего абонента (extension) :
```
{
    "exten": "8003",
    "context": "alnik"
}
```
где,
* "exten" - внутренний абонент, статус которого запрашивается - обязательное поле
* "context" - контекст внутреннего абонента - не обязательное поле

Ответ модуля на такой запрос имеет следующий вид :
```
{"result":0,"text":"Idle"} - абонент доступен
{"result":4,"text":"Unavailable"} - абонент не доступен
{"result":-1,"text":"Unknown"} - абоненте отсутствует в плане нумерации
```

### 1.4 Запрос статуса пира (peer) :
```
{
    "peer": "8003",
    "context": "alnik"
}
```
где,
* "peer" - пир, статус которого запрашивается - обязательное поле
* "context" - контекст пира - не обязательное поле

Ответ модуля на такой запрос имеет следующий вид :
```
{"result":0,"text":"Reachable"} - peer доступен
{"result":0,"text":"Unknown"} - peer не доступен
{"result":-1,"text":"Error"} - peer отсутствует в плане нумерации
```

### 1.5 Запрос статуса канала (channel) :
```
{
    "chan": "SIP/8003-00000020"
}
```
где,
* "chan" - канал, статус которого запрашивается - обязательное поле

Ответ модуля на такой запрос имеет следующий вид :
```
{"result":-1,"text":"Channel not present"} - канал отсутствует
{"result":0,"text":"Up (6)"} - канал присутствует (живой), в состоянии разговора
```

## 2. POST запросы, посылаемые модулем стороннему вэб-серверу (CRM) в формате json

Запросы формируются по следующим событиям (events) :

### 2.1 "Newchannel" - создан новый канал (для вызовов, прошедших через функцию Transfer модуля)
на сервер (CRM) посылается примерно такой запрос :
```
{"event":"Newchannel","chan":"SIP/8003-00000022","caller":"8003","exten":"0000","state":"DOWN"}
```
сервер (CRM) должен прислать ответ примерно такого вида :
```
{"result":0}
```

### 2.2 "Hangup" - канал прекратил своё существование (для вызовов, прошедших через функцию Transfer модуля)
на сервер (CRM) посылается примерно такой запрос :
```
{"event":"Hangup","chan":"SIP/8003-00000022","caller":"8003","exten":"0000","state":"UP"}
```
сервер (CRM) должен прислать ответ примерно такого вида :
```
{"result":0}
```

### 2.3 "Newexten" - статус абонента caller изменился(для вызовов, прошедших через функцию Transfer модуля или для всех вызовов)
на сервер (CRM) посылается примерно такой запрос :
```
{"event":"Newexten","chan":"SIP/8003-00000023","caller":"8003","exten":"0000","state":"RING"} - вызов на номер "0000"
```
или такой
```
{"event":"Newexten","chan":"SIP/8003-00000023","caller":"8003","exten":"0000","state":"UP","app":"Playback"} - соединение с номером "0000"
```
сервер (CRM) должен прислать ответ примерно такого вида :
```
{"result":0}
```

### 2.4 "AgentConnect" - агента ответил на вызов из очереди(для вызовов, прошедших через функцию Transfer модуля или для всех вызовов)
на сервер (CRM) посылается примерно такой запрос :
```
{"event":"AgentConnect","chan":"SIP/8003-00000025","caller":"8003","queue":"710","state":"UP","agent":"2222"} - соединение с номером "2222"
```
сервер (CRM) должен прислать ответ примерно такого вида :
```
{"result":0}
```

